if(typeof DEBUG_MODE==="undefined"){DEBUG_MODE=true;COLOR_MODE=navigator.userAgent.toLowerCase().indexOf("chrome")>-1;if(COLOR_MODE){EVENT_COLOR="#CC00FF";ENTER_COLOR="#009900";EXIT_COLOR="#880000"}}if(typeof EVENTABLE==="undefined"){EVENTABLE=true}var creator=function(){function F(){}F.prototype=this;return new F};var merge=function(obj,configs){var k;obj=obj||{};configs=configs||[];configs.forEach(function(x){if(typeof x==="object"){for(k in x){if(x.hasOwnProperty(k))obj[k]=x[k]}}});return obj};Stativus={DEFAULT_TREE:"default",SUBSTATE_DELIM:"SUBSTATE:",version:"0.9.3"};if(DEBUG_MODE){Stativus.DebugMessagingObject={level:0,_buildOutput:function(type,state,details,tree){tree=tree||Stativus.DEFAULT_TREE;var msg="Global::["+tree+"] ";msg=msg+"=> State::["+state+"]: ";msg=msg+"{"+type+"} > "+details;return msg},sendLog:function(type,state,details,tree){if(this.level>0)return;var msg=this._buildOutput(type,state,details,tree);console.log(msg);return msg},sendInfo:function(type,state,details,tree){if(this.level>1)return;var msg=this._buildOutput(type,state,details,tree);console.info(msg);return msg},sendWarn:function(type,state,details,tree){if(this.level>2)return;var msg=this._buildOutput(type,state,details,tree);console.error(msg);return msg},sendError:function(type,state,details,tree){if(this.level>3)return;var msg=this._buildOutput(type,state,details,tree);console.error(msg);return msg}}}Stativus.State={isState:true,_data:null,_isNone:function(value){return value===undefined||value===null},goToState:function(name,data){var sc=this.statechart;if(sc){sc.goToState(name,this.globalConcurrentState,this.localConcurrentState,data)}else{if(DEBUG_MODE){throw"Cannot goToState cause state doesnt have a statechart"}}},goToHistoryState:function(name,isRecursive){var sc=this.statechart;if(sc){sc.goToHistoryState(name,this.globalConcurrentState,this.localConcurrentState,isRecursive)}else{if(DEBUG_MODE){throw"Cannot goToState cause state doesnt have a statechart"}}},sendEvent:function(evt){var sc=this.statechart;if(sc){sc.sendEvent.apply(sc,arguments)}else{if(DEBUG_MODE){throw"Cannot sendEvent cause state doesnt have a statechart"}}},sendAction:function(evt){return this.sendEvent.apply(this,arguments)},getData:function(key){if(this._isNone(key))return key;var sc=this.statechart,ret=this._data[key];if(this._isNone(ret))ret=sc.getData(key,this.parentState,this.globalConcurrentState);return ret},setData:function(key,value){if(this._isNone(key))return value;this._data[key]=value},removeData:function(key){if(this._isNone(key))return key;var sc=this.statechart,ret=this._data[key];if(this._isNone(ret)){sc.removeData(key,this.parentState,this.globalConcurrentState)}else delete this._data[key]},setHistoryState:function(state){this.history=this.history||{};if(this.substatesAreConcurrent){this.history[this.localConcurrentState]=state.name;if(DEBUG_MODE){Stativus.DebugMessagingObject.sendLog("HISTORY STATE SET",this.name," substree = "+this.localConcurrentState+" => history state set to: "+state.name,this.globalConcurrentState)}}else{this.history=state.name;if(DEBUG_MODE){Stativus.DebugMessagingObject.sendLog("HISTORY STATE SET",this.name," history state set to: "+state.name,this.globalConcurrentState)}}}};Stativus.State.create=function(config){var nState,k,i,len;nState=creator.call(this);nState._data={};return merge(nState,[config])};Stativus.Statechart={isStatechart:true,create:function(config){var sc=creator.call(this);sc._all_states={};sc._all_states[Stativus.DEFAULT_TREE]={};sc._states_with_concurrent_substates={};sc._current_subtrees={};sc._current_state={};sc._current_state[Stativus.DEFAULT_TREE]=null;sc._goToStateLocked=false;sc._sendEventLocked=false;sc._pendingStateTransitions=[];sc._pendingEvents=[];sc._active_subtrees={};if(DEBUG_MODE){sc.inState=function(name,tree){var ret=false,cStates=this.currentState(tree);if(!cStates)throw"Doesn't appear that you are in any states, perhaps you forgot to 'initStates'?";cStates.forEach(function(x){if(x.name===name)ret=true});return ret};sc.getActiveStates=sc.currentState}return sc},addState:function(name){var tree,obj,hasConcurrentSubstates=false,pState,states,cTree,nState,config,configs=[],len,i,that=this;for(i=1,len=arguments.length;i<len;i++){configs[i-1]=config=arguments[i];hasConcurrentSubstates=hasConcurrentSubstates||!!config.substatesAreConcurrent;pState=pState||config.parentState}config=len===1?{}:merge(null,configs);config.name=name;config.statechart=this;config.history=null;tree=config.globalConcurrentState||Stativus.DEFAULT_TREE;config.globalConcurrentState=tree;cTree=this._states_with_concurrent_substates[tree];if(hasConcurrentSubstates){obj=this._states_with_concurrent_substates[tree]||{};obj[name]=true;this._states_with_concurrent_substates[tree]=obj}if(pState&&cTree&&cTree[pState]){pState=this._all_states[tree][pState];if(pState){pState.substates=pState.substates||[];pState.substates.push(name)}}nState=Stativus.State.create(config);obj=this._all_states[tree]||{};if(DEBUG_MODE){if(obj[name])throw["Trying to add state",name,"to state tree",tree,"and it already exists"].join(" ")}obj[name]=nState;this._all_states[tree]=obj;nState._beenAdded=true;states=nState.states||[];if(DEBUG_MODE){if(states.length===1&&nState.substatesAreConcurrent){throw["Trying to add substates in property 'states' to "+nState.name+", but must have more than ONE substate"]}}states.forEach(function(x,idx){var args=[],good=false,last;if(typeof x==="object"&&x.length>0){if(DEBUG_MODE){if(typeof x[0]!=="string"){throw"#addState: invalid substate array...Must have the name at index=0"}}args=args.concat(x);good=true}else if(typeof x==="string"){args.push(x);good=true}else if(typeof x==="object"){if(DEBUG_MODE){if(typeof x.name!=="string")throw"#addState: invalid substate hash...Must have a 'name' property"}args.push(x.name);args.push(x);good=true}if(good){last=args.length-1;args[last].parentState=name;args[last].globalConcurrentState=tree;that.addState.apply(that,args)}else{if(DEBUG_MODE)throw"#addState: invalid substate at index="+idx}});return this},initStates:function(init){var x,state;this._inInitialSetup=true;if(typeof init==="string"){this.goToState(init,Stativus.DEFAULT_TREE)}else if(typeof init==="object"){for(x in init){if(init.hasOwnProperty(x)){state=init[x];this.goToState(state,x)}}}this._inInitialSetup=false;this._flushPendingEvents();return this},goToState:function(requestedStateName,tree,concurrentTree,data){var cState,allStates=this._all_states[tree],idx,len,enterStates=[],exitStates=[],haveExited,enterMatchIndex,exitMatchIndex,that,reqState,pState,i,substateTree,enterStateHandled,exitStateHandled,substates;if(DEBUG_MODE){if(!tree)throw"#goToState: invalid global parallel state"}cState=concurrentTree?this._current_state[concurrentTree]:this._current_state[tree];reqState=allStates[requestedStateName];if(DEBUG_MODE){if(!reqState)throw"#goToState: Could not find requested state: "+requestedStateName}if(this._checkAllCurrentStates(reqState,concurrentTree||tree))return;if(typeof data!=="undefined"&&data!==null){if(DEBUG_MODE){Stativus.DebugMessagingObject.sendLog("SETTING DATA FOR TRANSITION FOR => "+requestedStateName)}if(typeof data==="string")reqState.setData(data,data);if(typeof data==="object"){for(var key in data){if(data.hasOwnProperty(key))reqState.setData(key,data[key])}}}if(this._goToStateLocked){this._pendingStateTransitions.push({requestedState:requestedStateName,tree:tree});return}this._goToStateLocked=true;enterStates=this._parentStatesWithRoot(reqState);exitStates=cState?this._parentStatesWithRoot(cState):[];enterMatchIndex=-1;for(idx=0,len=exitStates.length;idx<len;idx++){exitMatchIndex=idx;enterMatchIndex=enterStates.indexOf(exitStates[idx]);if(enterMatchIndex>=0)break}if(enterMatchIndex<0)enterMatchIndex=enterStates.length-1;this._enterStates=enterStates;this._enterStateMatchIndex=enterMatchIndex;this._enterStateConcurrentTree=concurrentTree;this._enterStateTree=tree;this._exitStateStack=[];if(cState&&cState.substatesAreConcurrent)this._fullExitFromSubstates(tree,cState);for(i=0;i<exitMatchIndex;i+=1){cState=exitStates[i];this._exitStateStack.push(cState)}this._unwindExitStateStack()},goToHistoryState:function(requestedState,tree,concurrentTree,isRecursive){var allStateForTree=this._all_states[tree],pState,realHistoryState;if(DEBUG_MODE){if(!tree||!allStateForTree)throw"#goToHistoryState: State requesting does not have a valid global parallel tree"}pState=allStateForTree[requestedState];if(pState)realHistoryState=pState.history||pState.initialSubstate;if(!realHistoryState){realHistoryState=requestedState}else if(isRecursive){this.goToHistoryState(realHistoryState,tree,isRecursive);return}this.goToState(realHistoryState,tree)},currentState:function(tree){var ret,tmp,sTree,aTrees,bTree,cStates=this._current_state,cState,i,len,state,ps,aStates;tree=tree||"default";cState=cStates[tree];aStates=this._all_states[tree];if(cState&&cState.isState){ret=this._parentStates(cState)}if(cState&&cState.substatesAreConcurrent){aTrees=this._active_subtrees[tree]||[];for(i=0,len=aTrees.length;i<len;i++){sTree=aTrees[i];state=cStates[sTree];if(state)ps=aStates[state.parentState];if(ps&&ret.indexOf(ps)<0)ret.unshift(ps);if(state&&ret.indexOf(state)<0)ret.unshift(state)}}return ret},sendEvent:function(evt){var args=[],len=arguments.length,i;if(len<1)return;for(i=1;i<len;i++){args[i-1]=arguments[i]}try{if(this._inInitialSetup||this._sendEventLocked||this._goToStateLocked){this._pendingEvents.push({evt:evt,args:args});return}this._sendEventLocked=true;this._processEvent(evt,args)}catch(err){this._restartEvents();throw err}this._restartEvents()},_processEvent:function(evt,args){this._structureCrawl("_cascadeEvents",evt,args)},getData:function(key,stateName,tree){var allStates=this._all_states[tree],state;if(!allStates)return null;state=allStates[stateName];if(state&&state.isState)return state.getData(key)},removeData:function(key,statename,tree){var allStates=this._all_states[tree],state;if(!allStates)return null;state=allStates[statename];if(state&&state.isState)return state.removeData(key)},getState:function(name,tree){var allStates,ret;tree=tree||Stativus.DEFAULT_TREE;allStates=this._all_states[tree];if(!allStates)return null;ret=allStates[name];return ret},_restartEvents:function(){this._sendEventLocked=false;if(!this._inInitialSetup)this._flushPendingEvents()},_structureCrawl:function(func,evt,args){var tree,currentStates=this._current_state,i,len,sResponder,tmp,allStates,responder,aTrees,sTree,handled,found,ss=Stativus.SUBSTATE_DELIM;for(tree in currentStates){if(!currentStates.hasOwnProperty(tree))continue;handled=false;sTree=null;responder=currentStates[tree];if(!responder||tree.slice(0,ss.length)===ss)continue;allStates=this._all_states[tree];if(!allStates)continue;aTrees=this._active_subtrees[tree]||[];for(i=0,len=aTrees.length;i<len;i++){sTree=aTrees[i];sResponder=currentStates[sTree];tmp=handled?[true,true]:this[func](evt,args,sResponder,allStates,sTree);handled=tmp[0];if(DEBUG_MODE)found=tmp[1]}if(!handled){tmp=this[func](evt,args,responder,allStates,null);handled=tmp[0];if(DEBUG_MODE){if(!found)found=tmp[1]}}if(DEBUG_MODE){if(!found){Stativus.DebugMessagingObject.sendLog("EVENT",this.name,"Fired {"+evt+"} with "+(args.length||0)+" argument(s) found NO state to handle this",this.globalConcurrentState)}}}},_cascadeEvents:function(evt,args,responder,allStates,tree){var handled,trees,len,ssName,found=false;if(tree){trees=tree.split("=>");len=trees.length||0;ssName=trees[len-1]}while(!handled&&responder){if(responder[evt]){if(DEBUG_MODE){Stativus.DebugMessagingObject.sendInfo("EVENT",responder.name,"Fired '"+evt+"' with "+(args.length||0)+" argument(s)",responder.globalConcurrentState)}try{handled=responder[evt].apply(responder,args)}catch(e){if(DEBUG_MODE){Stativus.DebugMessagingObject.sendError("EVENT",responder.name,"Fired '"+evt+"': Exception: "+e,responder.globalConcurrentState)}}found=true}if(tree&&ssName===responder.name)return[handled,found];responder=!handled&&responder.parentState?allStates[responder.parentState]:null}return[handled,found]},_checkAllCurrentStates:function(reqState,tree){var currentStates=this.currentState(tree)||[];if(currentStates===reqState)return true;else if(typeof currentStates==="string"&&reqState===this._all_states[tree][currentStates])return true;else if(currentStates.indexOf&&currentStates.indexOf(reqState)>-1)return true;else return false},_flushPendingEvents:function(){var args,pa=this._pendingEvents.shift();if(!pa)return;args=pa.args;args.unshift(pa.evt);this.sendEvent.apply(this,args)},_flushPendingStateTransitions:function(){var pending=this._pendingStateTransitions.shift(),msg;if(!pending)return false;this.goToState(pending.requestedState,pending.tree);return true},_parentStateObject:function(name,tree){if(name&&tree&&this._all_states[tree]&&this._all_states[tree][name]){return this._all_states[tree][name]}},_fullEnter:function(state){var pState,enterStateHandled=false;if(!state)return;try{if(state.enterState)state.enterState();if(state.didEnterState)state.didEnterState()}catch(e){if(DEBUG_MODE){Stativus.DebugMessagingObject.sendError("ENTER STATE",state.name,"EXECEPTION ["+e+"]",state.globalConcurrentState)}}if(DEBUG_MODE){Stativus.DebugMessagingObject.sendInfo("ENTER STATE",state.name,"Completed",state.globalConcurrentState)}if(state.parentState){pState=state.statechart.getState(state.parentState,state.globalConcurrentState);pState.setHistoryState(state)}this._unwindEnterStateStack()},_fullExit:function(state){var pState;if(!state)return;var exitStateHandled=false;try{if(state.exitState)state.exitState();if(state.didExitState)state.didExitState()}catch(e){if(DEBUG_MODE){Stativus.DebugMessagingObject.sendError("EXIT STATE",state.name,"EXECEPTION ["+e+"]",state.globalConcurrentState)}}if(DEBUG_MODE){Stativus.DebugMessagingObject.sendInfo("EXIT STATE",state.name,"Completed",state.globalConcurrentState)}this._unwindExitStateStack()},_initiateEnterStateSequence:function(){var enterStates,enterMatchIndex,concurrentTree,tree,allStates,i,cState;enterStates=this._enterStates;enterMatchIndex=this._enterStateMatchIndex;concurrentTree=this._enterStateConcurrentTree;tree=this._enterStateTree;allStates=this._all_states[tree];this._enterStateStack=this._enterStateStack||[];i=enterMatchIndex-1;cState=enterStates[i];if(cState)this._cascadeEnterSubstates(cState,enterStates,i-1,concurrentTree||tree,allStates);this._unwindEnterStateStack();enterStates=null;enterMatchIndex=null;concurrentTree=null;tree=null;delete this._enterStates;delete this._enterStateMatchIndex;delete this._enterStateConcurrentTree;delete this._enterStateTree},_cascadeEnterSubstates:function(start,requiredStates,index,tree,allStates){var cState,len=requiredStates.length,pState,subStates,that=this,nTree,bTree,name,currStates,aTrees,nTreeBase;if(!start)return;name=start.name;this._enterStateStack.push(start);this._current_state[tree]=start;start.localConcurrentState=tree;if(start.substatesAreConcurrent){tree=start.globalConcurrentState||Stativus.DEFAULT_TREE;nTreeBase=[Stativus.SUBSTATE_DELIM,tree,name].join("=>");start.history=start.history||{};subStates=start.substates||[];subStates.forEach(function(x){nTree=nTreeBase+"=>"+x;cState=allStates[x];bTree=cState.globalConcurrentState||Stativus.DEFAULT_TREE;aTrees=that._active_subtrees[bTree]||[];aTrees.unshift(nTree);that._active_subtrees[bTree]=aTrees;if(index>-1&&requiredStates[index]===cState)index-=1;that._cascadeEnterSubstates(cState,requiredStates,index,nTree,allStates)});return}else{cState=requiredStates[index];if(cState){if(index>-1&&requiredStates[index]===cState)index-=1;this._cascadeEnterSubstates(cState,requiredStates,index,tree,allStates)}else{cState=allStates[start.initialSubstate];this._cascadeEnterSubstates(cState,requiredStates,index,tree,allStates)}}},_fullExitFromSubstates:function(tree,stopState){var cStates,allStates,func,that=this;if(!tree||!stopState||!tree||!stopState.substates)return;allStates=this._all_states[tree];cStates=this._current_state;this._exitStateStack=this._exitStateStack||[];stopState.substates.forEach(function(state){var substateTree,currState,curr,exitStateHandled,aTrees;substateTree=[Stativus.SUBSTATE_DELIM,tree,stopState.name,state].join("=>");currState=cStates[substateTree];while(currState&&currState!==stopState){exitStateHandled=false;if(!currState)continue;that._exitStateStack.unshift(currState);if(currState.substatesAreConcurrent)that._fullExitFromSubstates(tree,currState);curr=currState.parentState;currState=allStates[curr]}that._active_subtrees[tree]=that._removeFromActiveTree(tree,substateTree)})},_unwindExitStateStack:function(){var stateToExit,delayForAsync=false,stateRestart,sc=this;this._exitStateStack=this._exitStateStack||[];stateToExit=this._exitStateStack.shift();if(stateToExit){if(stateToExit.willExitState){stateRestart=function(){var sc=this._statechart;if(DEBUG_MODE){Stativus.DebugMessagingObject.sendLog("ASYNC",stateToExit.name,"willExitState() completed!",stateToExit.globalConcurrentState)}if(sc)sc._fullExit(stateToExit)};delayForAsync=stateToExit.willExitState(stateRestart);if(DEBUG_MODE){if(delayForAsync){Stativus.DebugMessagingObject.sendLog("ASYNC",stateToExit.name,"exitState() delayed",stateToExit.globalConcurrentState)}else{Stativus.DebugMessagingObject.sendWarn("ASYNC",stateToExit.name,"Didn't return 'true' willExitState() which is needed if you want async",stateToExit.globalConcurrentState)}}}if(!delayForAsync)this._fullExit(stateToExit)}else{delete this._exitStateStack;this._initiateEnterStateSequence()}},_unwindEnterStateStack:function(){var stateToEnter,delayForAsync=false,stateRestart,more,that=this;this._exitStateStack=this._exitStateStack||[];stateToEnter=this._enterStateStack.shift();if(stateToEnter){if(stateToEnter.willEnterState){stateRestart=function(){if(DEBUG_MODE){Stativus.DebugMessagingObject.sendLog("ASYNC",stateToEnter.name,"willEnterState() completed!",stateToEnter.globalConcurrentState)}if(that)that._fullEnter(stateToEnter)};delayForAsync=stateToEnter.willEnterState(stateRestart);if(DEBUG_MODE){if(delayForAsync){Stativus.DebugMessagingObject.sendLog("ASYNC",stateToEnter.name,"enterState() delayed",stateToEnter.globalConcurrentState)}else{Stativus.DebugMessagingObject.sendWarn("ASYNC",stateToEnter.name,"Didn't return 'true' willEnterState() which is needed if you want async",stateToEnter.globalConcurrentState)}}}if(!delayForAsync)this._fullEnter(stateToEnter)}else{delete this._enterStateStack;this._goToStateLocked=false;more=this._flushPendingStateTransitions();if(!more&&!this._inInitialSetup){this._flushPendingEvents()}}},_removeFromActiveTree:function(baseTree,tree){var nArray=[],aTrees=this._active_subtrees[baseTree];if(!aTrees)return[];if(!tree)return aTrees;aTrees.forEach(function(x){if(x!==tree)nArray.push(x)});return nArray},_parentStates:function(state){var ret=[],curr=state;ret.push(curr);curr=this._parentStateObject(curr.parentState,curr.globalConcurrentState);while(curr){ret.push(curr);curr=this._parentStateObject(curr.parentState,curr.globalConcurrentState)}return ret},_parentStatesWithRoot:function(state){var ret=this._parentStates(state);ret.push("root");return ret}};Stativus.createStatechart=function(){return this.Statechart.create()};if(DEBUG_MODE){Stativus.Statechart.createStateTree=function(){var unprocessedStates=[];var addToTree=function(name,state,rootTree){function addSubstateToTree(parentState,stateName,state,tree){if(tree.name===parentState){tree.substates.push(createNode(state,stateName,tree));return true}return tree.substates.some(function(subtree){return addSubstateToTree(parentState,stateName,state,subtree)})}function addStateToTree(name,state){if(!state.parentState){rootTree.substates.push(createNode(state,name,rootTree));return true}return addSubstateToTree(state.parentState,name,state,rootTree)}return addStateToTree(name,state)};function createNode(state,name,parentTree){var events=Object.keys(state).filter(function(key){return key.slice(0,1)!=="_"&&state[key]&&["name","gotoState","sendAction","parentState","states","globalConcurrentState","history","statechart","localConcurrentState","initialSubstate","actions","substatesAreConcurrent","hasConcurrentSubstates"].every(function(excludedKey){return key!==excludedKey})}).map(function(key){return{name:key,content:state[key].toString()}});return{substates:[],name:name,initialSubstate:state.initialSubstate,hasConcurrentSubstates:state.hasConcurrentSubstates||!!state.substatesAreConcurrent,isConcurrentSubstate:parentTree&&parentTree.hasConcurrentSubstates,isInitialSubstate:parentTree&&parentTree.initialSubstate===name,events:events}}var allStatesTree=createNode({hasConcurrentSubstates:true},"global");function processState(stateHash,stateTree){return function(state){return!addToTree(state,stateHash[state],stateTree)}}function processFailedState(stateHash,stateTree){return function(invalidStateName){var invalidState=createNode(stateHash[invalidStateName],invalidStateName);invalidState.isInvalidState=true;stateTree.substates.push(invalidState)}}for(var globalStateName in this._all_states){if(this._all_states.hasOwnProperty(globalStateName)){var globalStateTree=createNode({},globalStateName,allStatesTree),globalState=this._all_states[globalStateName];allStatesTree.substates.push(globalStateTree);unprocessedStates=Object.keys(globalState);do{var statesToProcess=unprocessedStates.length;unprocessedStates=unprocessedStates.filter(processState(globalState,globalStateTree));if(statesToProcess===unprocessedStates.length){unprocessedStates.forEach(processFailedState(globalState,globalStateTree));break}}while(unprocessedStates.length>0)}}return allStatesTree}}if(DEBUG_MODE){Stativus.TestStateObject={_eventsCalled:null,_eventHandled:null,create:function(statechart){console.log("Creating TestStateObject...");var tso=creator.call(this);tso._eventsCalled={};tso._eventHandled={};tso._eventTransition={};tso._statechart=statechart;return tso},enterState:function(){this._statechart.sendEvent("enterState")},willEnterState:function(done){var that=this,innerDone=function(){that._willEnterStateDone=true;done()};this._statechart.sendEvent("willEnterState",innerDone)},willExitState:function(done){var that=this,innerDone=function(){that._willExitStateDone=true;done()};this._statechart.sendEvent("willExitState",innerDone)},exitState:function(){this._statechart.sendEvent("exitState")},wasEvent:function(name){var ret,eventCount=this._eventsCalled[name]||0,evtHandled=this._eventHandled[name]||false,evtTrans=this._eventTransition[name];ret={called:function(count){return count?count===eventCount:eventCount},handled:function(){return evtHandled},transitionedTo:function(name){return name===evtTrans}};return ret},transitionedTo:function(name){return name===this._transitionTo},willEnterCompleted:function(){return!!this._willEnterStateDone},willExitCompleted:function(){return!!this._willExitStateDone},reset:function(){delete this._eventsCalled;delete this._eventHandled;delete this._eventTransition;this._eventsCalled={};this._eventHandled={};this._eventTransition={}},_eventCalled:function(evt,handled){var cnt=this._eventsCalled[evt]||0;this._eventsCalled[evt]=cnt+1;this._eventHandled[evt]=handled},_setTransitionState:function(evt,stateName){this._eventTransition[evt]=stateName;this._transitionTo=stateName}};Stativus.Statechart.loadState=function(name,tree){var key,state,allStates;tree=tree||Stativus.DEFAULT_TREE;this._overloadFunctionsForTesting();this.isTestingStatechart=true;this._test_stateObjects=this._test_stateObjects||{};key=name+"_"+tree;allStates=this._all_states[tree];state=this._test_stateObjects[key]||Stativus.TestStateObject.create(this);this._current_test_state_object=state;this._current_loaded_state=allStates[name];return state};Stativus.Statechart._overloadFunctionsForTesting=function(){if(this.isTestingStatechart)return;this._processEvent=function(evt,args){var handled=false,currState=this._current_loaded_state,currTestObj=this._current_test_state_object;if(currState[evt]){this._current_testing_event=evt;handled=currState[evt].apply(currState,args);currTestObj._eventCalled(evt,handled);delete this._current_testing_event}};this.goToState=function(requestedStateName,tree,concurrentTree){var currTestObj=this._current_test_state_object,evt=this._current_testing_event;currTestObj._setTransitionState(evt,requestedStateName)}}}if(EVENTABLE){Stativus.Statechart._internalTryToPerform=function(node,evt,args){var that=this,lookup,selectors;if(!node||!node.className)return;selectors=node.className.split(/\s+/).map(function(x){return"."+x});if(node.id)selectors.push("#"+node.id);selectors.forEach(function(x){lookup=(x+" "+evt).replace(/^\s\s*/,"").replace(/\s\s*$/,"");that._structureCrawl("_cascadeActionHandler",lookup,args)})};Stativus.Statechart._cascadeActionHandler=function(lookup,args,responder,allStates,tree){var handled,trees,len,ssName,found=false,evt;if(tree){trees=tree.split("=>");len=trees.length||0;ssName=trees[len-1]}while(!handled&&responder){evt=responder.actions?responder.actions[lookup]:null;if(evt){if(DEBUG_MODE){Stativus.DebugMessagingObject.sendLog("EVENT LOOKUP",responder.name,["Will fire [",evt,"] for","["+lookup+"]","with",args.length||0,"argument(s)"].join(" "),responder.globalConcurrentState)}args.unshift(evt);this.sendEvent.apply(this,args);return[true,true]}if(tree&&ssName===responder.name)return[handled,found];responder=!handled&&responder.parentState?allStates[responder.parentState]:null}return[handled,found]};var jQueryIsLoaded=false;try{if(jQuery)jQueryIsLoaded=true}catch(err){jQueryIsLoaded=false}if(jQueryIsLoaded){var findEventableNodeData=function(start){var parents,evt,evts,args,node=$(start),found,ret;if(node.hasClass("eventable"))found=node;if(!found){parents=node.parents(".eventable");if(parents&&parents.length>0)found=parents}if(found){args=found.attr("data");args=args?args.split("::"):[];found=found[0]}return[found,args]};Stativus.Statechart.tryToPerform=function(evt){if(!evt)return;var args,selectors=[],tuple=findEventableNodeData(evt.target);if(!tuple[0])return;tuple[1].push(evt);this._internalTryToPerform(tuple[0],evt.type,tuple[1])}}else{Stativus.Statechart.tryToPerform=function(evt){if(!evt)return;var args=[],len=arguments.length,i,lookup;if(len<2)return;for(i=2;i<len;i++){args[i-2]=arguments[i]}args.push(evt);this._internalTryToPerform(evt.target,evt.type,args)}}}if(typeof window!=="undefined"){window.Stativus=Stativus}else if(typeof exports!=="undefined"){module.exports=Stativus}