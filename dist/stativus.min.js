var jQueryIsLoaded=!1;try{jQuery&&(jQueryIsLoaded=!0)}catch(a){jQueryIsLoaded=!1}var creator=function(){function a(){}return a.prototype=this,new a},merge=function(a,b){return a=a||{},b=b||[],b.forEach(function(b){if("object"==typeof b)for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}),a};Stativus={_DT:"default",_SSD:"SUBSTATE:",version:"1.0.0"},Stativus.State={isState:!0,_data:null,_isNone:function(a){return void 0===a||null===a},goToState:function(a,b){var c=this.statechart;c&&c.goToState(a,this.globalConcurrentState,this.localConcurrentState,b)},goToHistoryState:function(a,b){var c=this.statechart;c&&c.goToHistoryState(a,this.globalConcurrentState,this.localConcurrentState,b)},sendEvent:function(a){var b=this.statechart;b&&b.sendEvent.apply(b,arguments)},sendAction:function(a){return this.sendEvent.apply(this,arguments)},getData:function(a){if(this._isNone(a))return a;var b=this.statechart,c=this._data[a];return this._isNone(c)&&(c=b.getData(a,this.parentState,this.globalConcurrentState)),c},setData:function(a,b){if(this._isNone(a))return b;this._data[a]=b},removeData:function(a){if(this._isNone(a))return a;var b=this.statechart,c=this._data[a];this._isNone(c)?b.removeData(a,this.parentState,this.globalConcurrentState):delete this._data[a]},setHistoryState:function(a){this.history=this.substatesAreConcurrent?this.substates:a.name},_parseAndHandleEvents:function(a,b){var c=this.statechart;for(var d in a)if(a.hasOwnProperty(d)){var e,f,g,h;e=d.split(" "),f=e[0],g=d.replace(f,""),h=a[d],b?function(a,b){b?jQuery("body").off(a,b):jQuery("body").off(a)}(f,g):function(a,b,d){b?jQuery("body").on(a,b,function(a){c.sendEvent(d,a)}):jQuery("body").on(a,function(a){c.sendEvent(d,a)})}(f,g,h)}},_bindEvents:function(){var a=this.events||this.actions;a&&this._parseAndHandleEvents(a)},_unBindEvents:function(){var a=this.events||this.actions;a&&this._parseAndHandleEvents(a,!0)}},Stativus.State.create=function(a,b){var c,d=[a],e=a.name+"_"+a.globalConcurrentState,f=b._ciw[e];return c=creator.call(this),c._data={},f&&d.push(f),merge(c,d)},Stativus.Statechart={create:function(a){var b=creator.call(this);return b.isStatechart=!0,b._as={},b._as[Stativus._DT]={},b._swcss={},b._cts={},b._cs={},b._cs[Stativus._DT]=null,b._gtsl=!1,b._sel=!1,b._pst=[],b._pe=[],b._ast={},b._ciw={},b._pts={},b},addState:function(a){var b,c,d,e,f,g,h,i,j,k,l=!1,m=[],n=this;for(j=1,i=arguments.length;j<i;j++)m[j-1]=h=arguments[j],l=l||!!h.substatesAreConcurrent,b=b||h.globalConcurrentState,e=e||h.parentState;return b=b||Stativus._DT,h=1===i?{}:merge(null,m),h.name=a,h.statechart=this,h.globalConcurrentState=b,this._swcss[b],l&&(c=this._swcss[b]||{},c[a]=!0,this._swcss[b]=c),e&&(d=this._as[b][e],d||(k=e+"_"+b,this._ciw[k]=d=this._ciw[k]||{}),d.substates=d.substates||[],d.substates.push(a)),g=Stativus.State.create(h,this),c=this._as[b]||{},c[a]=g,this._as[b]=c,g._beenAdded=!0,f=g.states||[],f.forEach(function(c,d){var e,f=[],g=!1;"object"==typeof c&&c.length>0?(f=f.concat(c),g=!0):"string"==typeof c?(f.push(c),g=!0):"object"==typeof c&&(f.push(c.name),f.push(c),g=!0),g&&(e=f.length-1,f[e].parentState=a,f[e].globalConcurrentState=b,n.addState.apply(n,f))}),this},initStates:function(a){var b,c;if(this._inInitialSetup=!0,"string"==typeof a)this.goToState(a,Stativus._DT);else if("object"==typeof a)for(b in a)a.hasOwnProperty(b)&&(c=a[b],this.goToState(c,b));return this._inInitialSetup=!1,this._flushPendingEvents(),this},goToState:function(a,b,c,d){var e,f,g,h,i,j=this._as[b],k=[],l=[];if(e=c&&this._cs[c]||this._cs[b],"object"===(i=typeof a))g=this._compileStateTransitions(a,j);else{if("string"!==i)return;g=j[a]}if(!this._checkAllCurrentStates(g,c||b)){if(this._setDataOnState(g,d),this._gtsl)return void this._pst.push({requestedState:a,tree:b,localConcurrentState:c});for(this._gtsl=!0,k=this._pswr(g),l=e?this._pswr(e):[],f=this._fca(l,k),this._enterStates=k,this._enterStateMatchIndex=f.second,this._enterStateTree=b,this._ess=[],h=0;h<f.first;h+=1)e=l[h],e.substatesAreConcurrent&&this._fullExitFromSubstates(b,e),this._ess.push(e);this._uess()}},_fca:function(a,b){var c,d,e,f=-1;for(c=0,d=a.length;c<d&&(e=c,!((f=b.indexOf(a[c]))>=0));c++);return f<0&&(f=b.length-1),{first:e,second:f}},_compileStateTransitions:function(a,b){var c,d,e,f,g,h,i,j=!0;for(c in a)if(a.hasOwnProperty(c))if(d=a[c],j)e=b[d],g=this._parentStates(e),j=!1;else{if(h=this._parentStates(b[d]),f=this._fca(g,h),f.second<0)continue;if(i=h[f.second],!i.substatesAreConcurrent)continue;i=h[f.second-1],i&&(this._pts=this._pts||{},this._pts[i.name]=(this._pts[i.name]||0)+1,this._pst.push({requestedState:d,tree:i.globalConcurrentState,localConcurrentState:i.localConcurrentState}))}return e},goToHistoryState:function(a,b,c,d){var e,f,g=this._as[b];if(e=g[a],e&&(f=e.history||e.initialSubstate),f){if(d)return void this.goToHistoryState(f,b,d)}else f=a;this.goToState(f,b)},currentState:function(a){var b,c,d,e,f,g,h,i,j,k=this._cs;if(a=a||"default",e=k[a],j=this._as[a],e&&e.isState&&(b=this._parentStates(e)),e&&e.substatesAreConcurrent)for(d=this._ast[a]||[],f=0,g=d.length;f<g;f++)c=d[f],h=k[c],h&&(i=j[h.parentState]),i&&b.indexOf(i)<0&&b.unshift(i),h&&b.indexOf(h)<0&&b.unshift(h);return b},sendEvent:function(a){var b,c=[],d=arguments.length;if(!(d<1)){for(b=1;b<d;b++)c[b-1]=arguments[b];try{if(this._inInitialSetup||this._sel||this._gtsl)return void this._pe.push({evt:a,args:c});this._sel=!0,this._processEvent(a,c)}catch(a){throw this._restartEvents(),a}this._restartEvents()}},_setDataOnState:function(a,b){if(a&&void 0!==b&&null!==b&&("string"==typeof b&&a.setData(b,b),"object"==typeof b))for(var c in b)b.hasOwnProperty(c)&&a.setData(c,b[c])},_processEvent:function(a,b){this._structureCrawl("_cascadeEvents",a,b)},getData:function(a,b,c){var d,e=this._as[c];return e?(d=e[b],d&&d.isState?d.getData(a):void 0):null},removeData:function(a,b,c){var d,e=this._as[c];return e?(d=e[b],d&&d.isState?d.removeData(a):void 0):null},getState:function(a,b){var c;return b=b||Stativus._DT,(c=this._as[b])?c[a]:null},_restartEvents:function(){this._sel=!1,this._inInitialSetup||this._flushPendingEvents()},_structureCrawl:function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n=this._cs,o=Stativus._SSD;for(d in n)if(n.hasOwnProperty(d)){if(m=!1,l=null,!(j=n[d])||d.slice(0,o.length)===o)continue;if(!(i=this._as[d]))continue;for(k=this._ast[d]||[],e=0,f=k.length;e<f;e++)l=k[e],g=n[l],h=m?[!0,!0]:this[a](b,c,g,i,l),m=h[0];m||(h=this[a](b,c,j,i,null),m=h[0])}},_cascadeEvents:function(a,b,c,d,e){var f,g,h,i=!1;for(g=this._splitConcurrencyKey(e);!f&&c;){if(h=c[a]){try{f=h.apply(c,b)}catch(a){}i=!0}if(e&&g===c.name)return[f,i];c=!f&&c.parentState?d[c.parentState]:null}return[f,i]},_checkAllCurrentStates:function(a,b){var c=this.currentState(b)||[];return c===a||("string"==typeof c&&a===this._as[b][c]||!!(c.indexOf&&c.indexOf(a)>-1))},_flushPendingEvents:function(){var a,b=this._pe.shift();b&&(a=b.args,a.unshift(b.evt),this.sendEvent.apply(this,a))},_fpst:function(){var a=this._pst.shift();return!!a&&(this.goToState(a.requestedState,a.tree,a.localConcurrentState),!0)},_fullEnter:function(a){var b,c;if(a){this._addActiveConcurrentSubstate(a,a.localConcurrentState),c=a.localConcurrentState||a.globalConcurrentState,this._cs[c]=a;try{a.enterState&&a.enterState(),a.didEnterState&&a.didEnterState(),jQueryIsLoaded&&(a.actions||a.events)&&a._bindEvents()}catch(a){}a.parentState&&(b=a.statechart.getState(a.parentState,a.globalConcurrentState),b.setHistoryState(a)),this._unwindEnterStateStack()}},_fullExit:function(a){var b,c;if(a){try{jQueryIsLoaded&&(a.actions||a.events)&&a._unBindEvents(),a.exitState&&a.exitState(),a.didExitState&&a.didExitState(),b=a.localConcurrentState||a.globalConcurrentState,c=this._splitConcurrencyKey(b),c===a.name?delete this._cs[b]:this._cs[b]=this._as[a.globalConcurrentState][a.parentState]}catch(a){}this._uess()}},_iess:function(){var a,b,c,d,e,f;a=this._enterStates,b=this._enterStateMatchIndex,c=this._enterStateTree,d=this._as[c],this._enterStateStack=this._enterStateStack||[],e=b-1,f=a[e],c=this._getValidLocalConcurrentState(f)||c,f&&this._cess(f,a.slice(0,b),e-1,c,d),this._unwindEnterStateStack(),a=null,b=null,c=null,delete this._enterStates,delete this._enterStateMatchIndex,delete this._enterStateTree},_cess:function(a,b,c,d,e){var f,g,h,i,j,k,l=this;if(a&&!l._checkIfPausedState(a)){if(j=a.name,this._enterStateStack.push(a),a.localConcurrentState=d,a.substatesAreConcurrent)return d=a.globalConcurrentState||Stativus._DT,k=[Stativus._SSD,d,j].join("=>"),g=a.substates||[],void g.forEach(function(a){f=e[a],l._checkIfPausedState(f)||(i=k+"=>"+a,c>-1&&b[c]===f?(c-=1,h=b):h=[],l._cess(f,h,c,i,e))});f=b[c],f?(c>-1&&b[c]===f&&(c-=1),this._cess(f,b,c,d,e)):(f=e[a.initialSubstate],this._cess(f,b,c,d,e))}},_addActiveConcurrentSubstate:function(a,b){var c,d;b&&a.globalConcurrentState!==b&&(c=a.globalConcurrentState||Stativus._DT,d=this._ast[c]||[],d.indexOf(b)<0&&(d.unshift(b),this._ast[c]=d))},_checkIfPausedState:function(a){return!!this._pts[a.name]&&(this._pts[a.name]=this._pts[a.name]-1,!0)},_fullExitFromSubstates:function(a,b){var c,d,e=this;a&&b&&a&&b.substates&&(d=this._as[a],c=this._cs,this._ess=this._ess||[],b.substates.forEach(function(f){var g,h,i;for(g=[Stativus._SSD,a,b.name,f].join("=>"),h=c[g];h&&h!==b;)!1,h&&(e._ess.indexOf(h)<0&&(e._ess.push(h),h.substatesAreConcurrent&&e._fullExitFromSubstates(a,h)),i=h.parentState,h=d[i]);e._ast[a]=e._removeFromActiveTree(a,g)}))},_uess:function(){var a,b,c=!1,d=this;this._ess=this._ess||[],a=this._ess.shift(),a?(a.willExitState&&(b=function(){d&&d._fullExit(a)},c=a.willExitState(b)),c||this._fullExit(a)):(delete this._ess,this._iess())},_unwindEnterStateStack:function(){this._ess=this._ess||[];var a,b,c=!1,d=this;a=this._enterStateStack.shift(),a?(a.willEnterState&&(b=function(){d&&d._fullEnter(a)},c=a.willEnterState(b)),c||this._fullEnter(a)):(delete this._enterStateStack,this._gtsl=!1,this._fpst()||this._inInitialSetup||this._flushPendingEvents())},_removeFromActiveTree:function(a,b){var c=[],d=this._ast[a];return d?b?(d.forEach(function(a){a!==b&&c.push(a)}),c):d:[]},_parentStateObject:function(a,b){if(a&&b&&this._as[b])return this._as[b][a]},_parentStates:function(a){var b=[],c=a;for(b.push(c),c=this._parentStateObject(c.parentState,c.globalConcurrentState);c;)b.push(c),c=this._parentStateObject(c.parentState,c.globalConcurrentState);return b},_pswr:function(a){var b=this._parentStates(a);return b.push("root"),b},_splitConcurrencyKey:function(a){var b,c,d;return a&&(d=a.split("=>"),c=d.length||0,b=d[c-1]),b},_getValidLocalConcurrentState:function(a,b){if(a)return b=b||this._as[a.globalConcurrentState],a.localConcurrentState||this._getValidLocalConcurrentState(b[a.parentState],b)}},Stativus.createStatechart=function(){return this.Statechart.create()},"undefined"!=typeof window?window.Stativus=Stativus:"undefined"!=typeof exports&&(module.exports=Stativus);